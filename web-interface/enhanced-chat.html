<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Input - Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: #ffffff;
            color: #000000;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: #000000;
            color: #ffffff;
            padding: 20px 40px;
            border-bottom: 1px solid #333333;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 400;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .header-nav {
            display: flex;
            gap: 40px;
        }

        .header-nav a {
            color: #999999;
            text-decoration: none;
            font-size: 14px;
            font-weight: 400;
            transition: color 0.2s;
        }

        .header-nav a:hover,
        .header-nav a.active {
            color: #ffffff;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 40px;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #000000;
        }

        .section-subtitle {
            font-size: 16px;
            color: #666666;
            margin-bottom: 32px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-select {
            width: 100%;
            max-width: 300px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: #ffffff;
            transition: border-color 0.2s;
        }

        .form-select:focus {
            outline: none;
            border-color: #000000;
        }

        .form-textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #000000;
        }

        .form-textarea::placeholder {
            color: #999999;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
        }

        .btn-primary {
            background: #000000;
            color: #ffffff;
        }

        .btn-primary:hover:not(:disabled) {
            background: #333333;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Processing Status */
        .processing-status {
            background: #fff3cd;
            border: 2px solid #ffd60a;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            display: none;
            align-items: center;
            gap: 12px;
        }

        .processing-status.show {
            display: flex;
        }

        .status-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #ffd60a;
            border-top: 2px solid #000000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results Section */
        .results-section {
            background: #ffffff;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 40px;
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        .confidence-score {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666666;
        }

        .confidence-bar {
            width: 60px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.3s;
        }

        /* Analysis Grid */
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 32px;
        }

        .analysis-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }

        .analysis-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #000000;
        }

        .analysis-item {
            background: #ffffff;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #007bff;
        }

        .analysis-item.high-priority {
            border-left-color: #dc3545;
        }

        .analysis-item.medium-priority {
            border-left-color: #ffc107;
        }

        .analysis-item-meta {
            font-size: 12px;
            color: #666666;
            margin-top: 4px;
        }

        /* Recommendations */
        .recommendations {
            background: #e7f3ff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 24px;
        }

        .recommendations h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #0066cc;
        }

        .recommendation-item {
            background: #ffffff;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #0066cc;
        }

        .recommendation-item.urgent {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        /* Status Messages */
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: #ffffff;
            padding: 16px 24px;
            border-radius: 8px;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
        }

        .status-message.error {
            background: #dc3545;
        }

        .status-message.show {
            transform: translateX(0);
        }

        /* Activity Log */
        .activity-section {
            background: #ffffff;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 40px;
        }

        .activity-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #007bff;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .activity-member {
            font-weight: 600;
            color: #000000;
        }

        .activity-time {
            font-size: 12px;
            color: #666666;
        }

        .activity-stats {
            font-size: 14px;
            color: #666666;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
            }

            .main-content {
                padding: 40px 20px;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .input-section,
            .results-section,
            .activity-section {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Team Intelligence Input</h1>
            <nav class="header-nav">
                <a href="/chat" class="active">Team Input</a>
                <a href="/executive-dashboard">Executive Intelligence</a>
                <a href="/api/docs">API Documentation</a>
            </nav>
        </div>
    </div>

    <div class="main-content">
        <!-- Input Section -->
        <div class="input-section">
            <h2 class="section-title">Share Your Update</h2>
            <p class="section-subtitle">
                What's happening on your end? Share updates about clients, deals, meetings, or anything the team should know about.
            </p>

            <div class="form-group">
                <label class="form-label" for="memberSelect">Team Member</label>
                <select id="memberSelect" class="form-select">
                    <option value="">Who's sharing today?</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="updateText">Your Update</label>
                <textarea 
                    id="updateText" 
                    class="form-textarea"
                    placeholder="What's happening on your end? Share client meetings, deal progress, wins, concerns, or anything the team should know. Just write naturally - I'll take care of organizing everything."
                ></textarea>
            </div>

            <button id="submitBtn" class="btn btn-primary">
                Share Update
            </button>

            <div id="processingStatus" class="processing-status">
                <div class="status-spinner"></div>
                <span>Reading through your update...</span>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="results-section">
            <div class="results-header">
                <h2 class="section-title">Here's What I Noticed</h2>
                <div class="confidence-score">
                    <span>How confident:</span>
                    <div class="confidence-bar">
                        <div id="confidenceFill" class="confidence-fill"></div>
                    </div>
                    <span id="confidenceText">--</span>
                </div>
            </div>

            <div class="analysis-grid">
                <div class="analysis-card">
                    <h3>✅ Action Items</h3>
                    <div id="actionItems"></div>
                </div>

                <div class="analysis-card">
                    <h3>🏢 Client Activity</h3>
                    <div id="clientInfo"></div>
                </div>

                <div class="analysis-card">
                    <h3>🔥 Things That Need Attention</h3>
                    <div id="priorities"></div>
                </div>

                <div class="analysis-card">
                    <h3>💡 Key Takeaways</h3>
                    <div id="insights"></div>
                </div>
            </div>

            <div id="recommendations" class="recommendations" style="display: none;">
                <h3>📝 Next Steps to Consider</h3>
                <div id="recommendationsList"></div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="activity-section">
            <h2 class="section-title">Team Activity</h2>
            <p class="section-subtitle">What the team's been up to</p>
            <div id="activityLog"></div>
        </div>
    </div>

    <!-- Status Message -->
    <div id="statusMessage" class="status-message"></div>

    <script>
        class EnhancedTeamInterface {
            constructor() {
                this.elements = {
                    memberSelect: document.getElementById('memberSelect'),
                    updateText: document.getElementById('updateText'),
                    submitBtn: document.getElementById('submitBtn'),
                    processingStatus: document.getElementById('processingStatus'),
                    resultsSection: document.getElementById('resultsSection'),
                    statusMessage: document.getElementById('statusMessage'),
                    activityLog: document.getElementById('activityLog')
                };

                this.ws = null;
                this.init();
            }

            async init() {
                await this.loadTeamMembers();
                this.setupEventListeners();
                this.initWebSocket();
            }

            async loadTeamMembers() {
                try {
                    const response = await fetch('/api/team');
                    const members = await response.json();
                    
                    this.elements.memberSelect.innerHTML = '<option value="">Who\'s sharing today?</option>';
                    members.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.key || member.id;
                        option.textContent = `${member.name} (${member.role})`;
                        this.elements.memberSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Failed to load team members:', error);
                    this.showStatus('Couldn\'t load the team list - refresh and try again?', true);
                }
            }

            setupEventListeners() {
                this.elements.submitBtn.addEventListener('click', () => this.submitUpdate());
                
                this.elements.updateText.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        this.submitUpdate();
                    }
                });
            }

            initWebSocket() {
                try {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    this.ws = new WebSocket(`${protocol}//${window.location.host}`);
                    
                    this.ws.onopen = () => {
                        console.log('Connected to live team updates');
                        this.ws.send(JSON.stringify({
                            type: 'subscribe',
                            channel: 'team-updates'
                        }));
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            this.handleWebSocketMessage(message);
                        } catch (error) {
                            console.error('Failed to parse WebSocket message:', error);
                        }
                    };
                    
                    this.ws.onclose = () => {
                        console.log('Lost connection to live updates - reconnecting...');
                        setTimeout(() => this.initWebSocket(), 5000);
                    };
                } catch (error) {
                    console.error('Couldn\'t connect to live updates:', error);
                }
            }

            async submitUpdate() {
                const memberName = this.elements.memberSelect.value;
                const updateText = this.elements.updateText.value.trim();

                if (!memberName || !updateText) {
                    this.showStatus('Hey! Don\'t forget to pick your name and share what\'s happening', true);
                    return;
                }

                if (updateText.length < 10) {
                    this.showStatus('Could you share a bit more detail? That\'ll help us understand better', true);
                    return;
                }

                this.setProcessingState(true);

                try {
                    const response = await fetch('/api/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ memberName, updateText })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        this.showResults(data);
                        this.showStatus('Thanks for sharing! Here\'s what I picked up on...');
                        this.elements.updateText.value = '';
                        this.addActivityItem(data);
                    } else {
                        this.handleError(data);
                    }

                } catch (error) {
                    this.handleError({
                        error: { 
                            message: 'Hmm, looks like there\'s a connection hiccup. Mind trying again?',
                            type: 'network_error'
                        },
                        support: {
                            troubleshooting: ['Give your internet a quick check', 'Let\'s try again in just a sec']
                        }
                    });
                } finally {
                    this.setProcessingState(false);
                }
            }

            setProcessingState(processing) {
                this.elements.submitBtn.disabled = processing;
                this.elements.submitBtn.textContent = processing ? 'Reading...' : 'Share Update';
                
                if (processing) {
                    this.elements.processingStatus.classList.add('show');
                } else {
                    this.elements.processingStatus.classList.remove('show');
                }
            }

            showResults(data) {
                this.elements.resultsSection.classList.add('show');

                // Update confidence score
                const confidence = data.analysis?.confidence || 0;
                document.getElementById('confidenceFill').style.width = `${confidence * 100}%`;
                document.getElementById('confidenceText').textContent = `${Math.round(confidence * 100)}%`;

                // Update analysis sections
                this.updateAnalysisSection('actionItems', data.analysis?.actionItems || [], (item) => {
                    const urgency = item.urgency || 'low';
                    const priorityClass = urgency === 'critical' ? 'high-priority' : 
                                        urgency === 'high' ? 'medium-priority' : '';
                    
                    return `
                        <div class="analysis-item ${priorityClass}">
                            <div>${item.text}</div>
                            <div class="analysis-item-meta">
                                Importance: ${item.priority}/5 | 
                                Owner: ${item.assignee || 'No one yet'} |
                                How sure: ${Math.round((item.confidence || 0) * 100)}%
                                ${item.deadline ? ` | Due by: ${new Date(item.deadline).toLocaleDateString()}` : ''}
                            </div>
                        </div>
                    `;
                });

                this.updateAnalysisSection('clientInfo', data.analysis?.clients || [], (client) => {
                    const riskClass = client.riskLevel === 'high' ? 'high-priority' : 
                                    client.riskLevel === 'medium' ? 'medium-priority' : '';
                    
                    return `
                        <div class="analysis-item ${riskClass}">
                            <div><strong>${client.name}</strong> - ${client.status}</div>
                            <div class="analysis-item-meta">
                                ${client.dealValue ? `Deal size: $${client.dealValue.toLocaleString()} | ` : ''}
                                Risk level: ${client.riskLevel || 'unclear'} |
                                How sure: ${Math.round((client.confidence || 0) * 100)}%
                            </div>
                        </div>
                    `;
                });

                this.updateAnalysisSection('priorities', data.analysis?.priorities || [], (priority) => {
                    const urgencyClass = priority.urgency === 'critical' ? 'high-priority' : 
                                       priority.urgency === 'high' ? 'medium-priority' : '';
                    
                    return `
                        <div class="analysis-item ${urgencyClass}">
                            <div>${priority.item}</div>
                            <div class="analysis-item-meta">
                                How urgent: ${priority.urgency} |
                                Business impact: ${priority.businessImpact} |
                                How sure: ${Math.round((priority.confidence || 0) * 100)}%
                            </div>
                        </div>
                    `;
                });

                this.updateAnalysisSection('insights', data.extracted?.keyInsights || [], (insight) => {
                    return `<div class="analysis-item"><div>${insight}</div></div>`;
                });

                // Update recommendations
                if (data.recommendations && data.recommendations.length > 0) {
                    document.getElementById('recommendations').style.display = 'block';
                    this.updateRecommendations(data.recommendations);
                } else {
                    document.getElementById('recommendations').style.display = 'none';
                }
            }

            updateAnalysisSection(elementId, items, formatter) {
                const element = document.getElementById(elementId);
                if (items.length === 0) {
                    element.innerHTML = '<div class="analysis-item"><div style="color: #666;">Nothing to highlight in this category</div></div>';
                } else {
                    element.innerHTML = items.map(formatter).join('');
                }
            }

            updateRecommendations(recommendations) {
                const element = document.getElementById('recommendationsList');
                element.innerHTML = recommendations.map(rec => {
                    const urgentClass = rec.priority === 'high' ? 'urgent' : '';
                    return `
                        <div class="recommendation-item ${urgentClass}">
                            <div><strong>${rec.action}</strong></div>
                            <div class="analysis-item-meta">
                                ${rec.reason ? `Why: ${rec.reason}` : ''}
                                ${rec.details ? ` | More info: ${rec.details.join(', ')}` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            handleError(data) {
                console.error('Update processing error:', data);
                
                let message = 'Oops, something went wrong. Let\'s try that again?';
                let troubleshooting = [];

                if (data.error) {
                    message = data.error.message || message;
                    troubleshooting = data.support?.troubleshooting || [];
                }

                this.showStatus(message, true);

                if (troubleshooting.length > 0) {
                    setTimeout(() => {
                        this.showStatus(`Maybe ${troubleshooting[0].toLowerCase()}?`, false);
                    }, 3000);
                }
            }

            addActivityItem(data) {
                const activityLog = this.elements.activityLog;
                const time = new Date().toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });

                const confidencePercent = Math.round((data.analysis?.confidence || 0) * 100);
                const hasEscalation = data.analysis?.executiveEscalation?.required;

                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <div class="activity-header">
                        <div class="activity-member">${data.memberName}</div>
                        <div class="activity-time">${time}</div>
                    </div>
                    <div class="activity-stats">
                        Found ${data.extracted?.totalItems || 0} things to track | 
                        ${confidencePercent}% sure about this | 
                        Took ${data.metadata?.processingTime?.toFixed(1) || '?'}s to read
                        ${hasEscalation ? ' | ⚠️ Leadership should know about this' : ''}
                        ${data.metadata?.fallbackUsed ? ' | Had to use backup processing' : ''}
                    </div>
                `;

                activityLog.insertBefore(activityItem, activityLog.firstChild);

                // Keep only last 10 items
                while (activityLog.children.length > 10) {
                    activityLog.removeChild(activityLog.lastChild);
                }
            }

            handleWebSocketMessage(message) {
                if (message.type === 'channel-broadcast' && message.channel === 'team-updates') {
                    const data = message.data;
                    if (data.type === 'updateProcessed') {
                        // Add real-time activity from other team members
                        this.addRealTimeActivity(data.data);
                    }
                }
            }

            addRealTimeActivity(data) {
                // Only show updates from other team members
                const currentMember = this.elements.memberSelect.value;
                if (data.memberName === currentMember) return;

                const activityLog = this.elements.activityLog;
                const time = new Date().toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });

                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.style.borderLeftColor = '#28a745';
                activityItem.innerHTML = `
                    <div class="activity-header">
                        <div class="activity-member">${data.memberName} (Just now)</div>
                        <div class="activity-time">${time}</div>
                    </div>
                    <div class="activity-stats">
                        Found ${data.extractedItems || 0} things to track | 
                        ${Math.round((data.confidence || 0) * 100)}% sure about this
                        ${data.hasEscalation ? ' | ⚠️ Leadership should know about this' : ''}
                    </div>
                `;

                activityLog.insertBefore(activityItem, activityLog.firstChild);

                // Keep only last 10 items
                while (activityLog.children.length > 10) {
                    activityLog.removeChild(activityLog.lastChild);
                }
            }

            showStatus(message, isError = false) {
                const statusEl = this.elements.statusMessage;
                statusEl.textContent = message;
                statusEl.className = `status-message ${isError ? 'error' : ''} show`;
                
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 4000);
            }
        }

        // Initialize the enhanced interface
        document.addEventListener('DOMContentLoaded', () => {
            new EnhancedTeamInterface();
        });
    </script>
</body>
</html>
